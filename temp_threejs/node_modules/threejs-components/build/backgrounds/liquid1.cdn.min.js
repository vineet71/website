import{Clock as e,PerspectiveCamera as t,Scene as i,WebGLRenderer as s,SRGBColorSpace as r,MathUtils as n,Vector2 as a,TextureLoader as o,WebGLRenderTarget as h,RGBAFormat as d,FloatType as l,ShaderMaterial as c,Uniform as m,Object3D as p,Mesh as u,PlaneGeometry as v,MeshBasicMaterial as f,MeshPhysicalMaterial as g,EquirectangularReflectionMapping as x}from"https://cdn.jsdelivr.net/npm/three@0.180.0/+esm";import"https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/loaders/GLTFLoader.js/+esm";import"https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/loaders/DRACOLoader.js/+esm";import{RGBELoader as w}from"https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/loaders/RGBELoader.js/+esm";import{FullScreenQuad as z}from"https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/postprocessing/Pass.js/+esm";class y{#e;canvas;camera;cameraMinAspect;cameraMaxAspect;cameraFov;maxPixelRatio;minPixelRatio;scene;renderer;#t;size={width:0,height:0,wWidth:0,wHeight:0,ratio:0,pixelRatio:0};render=this.#i;onBeforeRender=()=>{};onAfterRender=()=>{};onAfterResize=()=>{};#s=!1;#r=!1;isDisposed=!1;#n;#a;#o;#h=new e;#d={elapsed:0,delta:0};#l;constructor(e){this.#e={...e},this.#c(),this.#m(),this.#p(),this.resize(),this.#u()}#c(){this.camera=new t,this.cameraFov=this.camera.fov}#m(){this.scene=new i}#p(){this.#e.canvas?this.canvas=this.#e.canvas:this.#e.id?this.canvas=document.getElementById(this.#e.id):console.error("Three: Missing canvas or id parameter"),this.canvas.style.display="block";const e={canvas:this.canvas,powerPreference:"high-performance",...this.#e.rendererOptions??{}};this.renderer=new s(e),this.renderer.outputColorSpace=r}#u(){this.#e.size instanceof Object||(window.addEventListener("resize",this.#v.bind(this)),"parent"===this.#e.size&&(this.#a=new ResizeObserver(this.#v.bind(this)),this.#a.observe(this.canvas.parentNode))),this.#n=new IntersectionObserver(this.#f.bind(this),{root:null,rootMargin:"0px",threshold:0}),this.#n.observe(this.canvas),document.addEventListener("visibilitychange",this.#g.bind(this))}#x(){window.removeEventListener("resize",this.#v.bind(this)),this.#a?.disconnect(),this.#n?.disconnect(),document.removeEventListener("visibilitychange",this.#g.bind(this))}#f(e){this.#s=e[0].isIntersecting,this.#s?this.#w():this.#z()}#g(e){this.#s&&(document.hidden?this.#z():this.#w())}#v(){this.#o&&clearTimeout(this.#o),this.#o=setTimeout(this.resize.bind(this),100)}resize(){let e,t;this.#e.size instanceof Object?(e=this.#e.size.width,t=this.#e.size.height):"parent"===this.#e.size&&this.canvas.parentNode?(e=this.canvas.parentNode.offsetWidth,t=this.canvas.parentNode.offsetHeight):(e=window.innerWidth,t=window.innerHeight),this.size.width=e,this.size.height=t,this.size.ratio=e/t,this.#y(),this.#M(),this.onAfterResize(this.size)}#y(){this.camera.aspect=this.size.width/this.size.height,this.camera.isPerspectiveCamera&&this.cameraFov&&(this.cameraMinAspect&&this.camera.aspect<this.cameraMinAspect?this.#R(this.cameraMinAspect):this.cameraMaxAspect&&this.camera.aspect>this.cameraMaxAspect?this.#R(this.cameraMaxAspect):this.camera.fov=this.cameraFov),this.camera.updateProjectionMatrix(),this.updateWorldSize()}#R(e){const t=Math.tan(n.degToRad(this.cameraFov/2))/(this.camera.aspect/e);this.camera.fov=2*n.radToDeg(Math.atan(t))}updateWorldSize(){if(this.camera.isPerspectiveCamera){const e=this.camera.fov*Math.PI/180;this.size.wHeight=2*Math.tan(e/2)*this.camera.position.length(),this.size.wWidth=this.size.wHeight*this.camera.aspect}else this.camera.isOrthographicCamera&&(this.size.wHeight=this.camera.top-this.camera.bottom,this.size.wWidth=this.camera.right-this.camera.left)}#M(){this.renderer.setSize(this.size.width,this.size.height),this.#t?.setSize(this.size.width,this.size.height);let e=window.devicePixelRatio;this.maxPixelRatio&&e>this.maxPixelRatio?e=this.maxPixelRatio:this.minPixelRatio&&e<this.minPixelRatio&&(e=this.minPixelRatio),this.renderer.setPixelRatio(e),this.size.pixelRatio=e}get postprocessing(){return this.#t}set postprocessing(e){this.#t=e,this.render=e.render.bind(e)}#w(){if(this.#r)return;console.log("Start rendering");const e=()=>{this.#l=requestAnimationFrame(e),this.#d.delta=this.#h.getDelta(),this.#d.elapsed+=this.#d.delta,this.onBeforeRender(this.#d),this.render(),this.onAfterRender(this.#d)};this.#r=!0,this.#h.start(),e()}#z(){this.#r&&(console.log("Stop rendering"),cancelAnimationFrame(this.#l),this.#r=!1,this.#h.stop())}#i(){this.renderer.render(this.scene,this.camera)}clear(){this.scene.traverse(e=>{e.isMesh&&"object"==typeof e.material&&(Object.keys(e.material).forEach(t=>{const i=e.material[t];null!==i&&"object"==typeof i&&"function"==typeof i.dispose&&i.dispose()}),e.material.dispose(),e.geometry.dispose())}),this.scene.clear()}dispose(){console.log("dispose"),this.#x(),this.#z(),this.clear(),this.#t?.dispose(),this.renderer.dispose(),this.isDisposed=!0}}const M=new Map,R=new a;let D,P,b=!1;function S(e){const t={position:new a,nPosition:new a,hover:!1,onEnter(){},onMove(){},onClick(){},onLeave(){},...e};return function(e,t){M.has(e)||(M.set(e,t),b||(document.body.addEventListener("pointermove",E),document.body.addEventListener("pointerleave",A),document.body.addEventListener("click",C),b=!0))}(e.domElement,t),t.dispose=()=>{var t;t=e.domElement,M.delete(t),0===M.size&&(document.body.removeEventListener("pointermove",E),document.body.removeEventListener("pointerleave",A),b=!1)},t}function E(e){R.x=e.clientX,R.y=e.clientY;for(const[e,t]of M){const i=e.getBoundingClientRect();U(i)?(I(t,i),t.hover||(t.hover=!0,t.onEnter(t)),t.onMove(t)):t.hover&&(t.hover=!1,t.onLeave(t))}}function C(e){R.x=e.clientX,R.y=e.clientY;for(const[e,t]of M){const i=e.getBoundingClientRect();I(t,i),U(i)&&t.onClick(t)}}function A(){for(const e of M.values())e.hover&&(e.hover=!1,e.onLeave(e))}function I(e,t){const{position:i,nPosition:s}=e;i.x=R.x-t.left,i.y=R.y-t.top,s.x=i.x/t.width*2-1,s.y=-i.y/t.height*2+1}function U(e){const{x:t,y:i}=R,{left:s,top:r,width:n,height:a}=e;return t>=s&&t<=s+n&&i>=r&&i<=r+a}async function j(e,t){let i;return i=e.endsWith(".hdr")?await function(e,t){P||(P=new w);return P.loadAsync(e,t)}(e,t):await function(e,t){D||(D=new o);return D.loadAsync(e,t)}(e,t),i}var q="varying vec2 vUv;void main(){vUv=uv;gl_Position=vec4(position,1.0);}";class F{#D;#P;#b;#S;#E;#C;#A;#I;#U;#j;#q;#F;constructor({renderer:e,size:t=512}){this.#D=e,this.#P=t,this.#b=t,this.#S={value:new a(1/this.#P,1/this.#b).multiplyScalar(.5)},this.#E={value:.995},this.#L(),this.#O()}#L(){const e={type:l,format:d,depthBuffer:!1};this.#C=new h(this.#P,this.#b,e),this.#A=new h(this.#P,this.#b,e),this.#I=new z}#O(){this.#U=new c({uniforms:{tDiffuse:{value:null}},vertexShader:q,fragmentShader:"uniform sampler2D tDiffuse;varying vec2 vUv;void main(){gl_FragColor=texture2D(tDiffuse,vUv);}"}),this.#j=new c({uniforms:{tDiffuse:{value:null},delta:this.#S,attenuation:this.#E},vertexShader:q,fragmentShader:"uniform sampler2D tDiffuse;uniform vec2 delta;uniform float attenuation;varying vec2 vUv;void main(){vec4 texel=texture2D(tDiffuse,vUv);vec2 dx=vec2(delta.x,0.0);vec2 dy=vec2(0.0,delta.y);float average=(texture2D(tDiffuse,vUv-dx).r+texture2D(tDiffuse,vUv-dy).r+texture2D(tDiffuse,vUv+dx).r+texture2D(tDiffuse,vUv+dy).r)*0.25;texel.g+=(average-texel.r)*2.0;texel.g*=attenuation;texel.r+=texel.g;gl_FragColor=texel;}"}),this.#q=new c({uniforms:{tDiffuse:{value:null},delta:this.#S},vertexShader:q,fragmentShader:"uniform sampler2D tDiffuse;uniform vec2 delta;varying vec2 vUv;void main(){vec4 texel=texture2D(tDiffuse,vUv);vec3 dx=vec3(delta.x,0.0,texture2D(tDiffuse,vec2(vUv.x+delta.x,vUv.y)).r-texel.r);vec3 dy=vec3(0.0,delta.y,texture2D(tDiffuse,vec2(vUv.x,vUv.y+delta.y)).r-texel.r);texel.ba=normalize(cross(dx,dy)).xy;gl_FragColor=texel;}"}),this.#F=new c({uniforms:{tDiffuse:{value:null},center:new m(new a),radius:{value:.05},strength:{value:.5}},vertexShader:q,fragmentShader:"const float PI=3.1415926535897932384626433832795;uniform sampler2D tDiffuse;uniform vec2 center;uniform float radius;uniform float strength;varying vec2 vUv;void main(){vec4 texel=texture2D(tDiffuse,vUv);float drop=max(0.0,1.0-length(center*0.5+0.5-vUv)/radius);drop=0.5-cos(drop*PI)*0.5;texel.r+=drop*strength;gl_FragColor=texel;}"})}get texture(){return this.#C.texture}update(){this.#T(),this.#k()}#T(){this.#j.uniforms.tDiffuse.value=this.#C.texture,this.#B(this.#j,this.#A),this.#W()}#k(){this.#q.uniforms.tDiffuse.value=this.#C.texture,this.#B(this.#q,this.#A),this.#W()}addDrop(e,t,i,s){this.#F.uniforms.tDiffuse.value=this.#C.texture,this.#F.uniforms.center.value.set(e,t),this.#F.uniforms.radius.value=i,this.#F.uniforms.strength.value=s,this.#B(this.#F,this.#A),this.#W()}setAttenuation(e){this.#E.value=e}#B(e,t){this.#I.material=e;const i=this.#D.getRenderTarget();this.#D.setRenderTarget(t),this.#I.render(this.#D),this.#D.setRenderTarget(i)}#W(){const e=this.#C;this.#C=this.#A,this.#A=e}dispose(){this.#U.dispose(),this.#j.dispose(),this.#q.dispose(),this.#F.dispose(),this.#C.dispose(),this.#A.dispose()}}class L extends p{#H;#N;#V;#_;constructor({renderer:e}){super(),this.#H=new F({renderer:e}),this.#N=new u(new v,new f),this.#N.rotation.x=-Math.PI/2,this.#N.position.y=-.1,this.#N.visible=!1,this.add(this.#N);const t=new g({color:"#ffffff",transmission:1,thickness:.25,metalness:.2,roughness:0});t.onBeforeCompile=e=>{e.uniforms.displacementMap={value:this.#H.texture},e.uniforms.displacementScale={value:1},e.vertexShader="\n        uniform sampler2D displacementMap;\n        uniform float displacementScale;\n      "+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n        vec3 transformed = vec3(position);\n        vec4 disp = texture2D(displacementMap, uv);\n        vNormal = normalMatrix * vec3(disp.b, disp.a, sqrt(1.0 - dot(disp.ba, disp.ba)));\n        transformed.z = displacementScale * disp.r;\n      ")},this.#V=new u(new v(1,1,256,256),t),this.#V.rotation.x=-Math.PI/2,this.add(this.#V);["attenuation","color","envMapIntensity","metalness","roughness","thickness","transmission"].forEach(e=>{Object.defineProperty(this,e,{get(){return this.#V.material[e]},set(t){"attenuation"===e?this.#H.setAttenuation(t):"color"===e?this.#V.material.color.set(t):this.#V.material[e]=t}})})}update(){this.#H.update()}addDrop(e,t,i,s){const r=this.#_>1?e:e*this.#_,n=this.#_>1?t/this.#_:t;this.#H.addDrop(r,n,i,s)}setImage(e){this.#N.material.map=e,this.#N.material.needsUpdate=!0,this.#N.visible=!!e,this.#Q()}#Q(){const e=this.#N.material.map;if(e&&e.image){const t=e.image.width/e.image.height;this.#_<t?this.#N.scale.set(t,1,1):this.#N.scale.set(this.#_,this.#_/t,1)}}setEnvMap(e){this.#V.material.envMap=e,this.#V.material.needsUpdate=!0}setSize({wWidth:e,wHeight:t,ratio:i}){this.#_=i;const s=e>t?i*t:e/i;this.#V.scale.set(s,s,1),this.#Q()}dispose(){this.#H.dispose()}}const{randFloatSpread:O,randFloat:T}=n;function k(e,t={}){const i=new y({canvas:e,size:"parent"});i.camera.fov=20,i.camera.position.y=1,i.camera.lookAt(0,0,0),i.updateWorldSize();const s=new L({renderer:i.renderer});s.setSize(i.size),i.scene.add(s);const n={enable:!0,time:0,timeDelta:.5},a=S({domElement:e});return a.onMove=()=>{s.addDrop(a.nPosition.x,a.nPosition.y,.025,.0025)},a.onClick=()=>{s.addDrop(a.nPosition.x,a.nPosition.y,.025,.05)},i.onBeforeRender=e=>{n.enable&&(n.time+=e.delta,n.time>n.timeDelta&&(s.addDrop(O(2),O(2),T(.01,.025),T(.001,.002)),n.time=0)),s.update()},i.onAfterResize=e=>{s.setSize(e)},{three:i,liquidPlane:s,async loadImage(e){if(e){const t=await j(e);t.colorSpace=r,s.setImage(t)}else s.setImage(null)},async loadEnvMap(e){if(e){const t=await j(e);t.mapping=x,s.setEnvMap(t)}else s.setEnvMap(null)},setRain(e){n.enable=e},setRainTime(e){n.timeDelta=e},dispose:()=>{a.dispose(),s.dispose(),i.dispose()}}}export{k as default};
