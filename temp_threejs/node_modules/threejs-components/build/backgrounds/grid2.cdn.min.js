import{Clock as e,PerspectiveCamera as t,Scene as i,WebGLRenderer as s,SRGBColorSpace as n,MathUtils as o,Vector2 as r,Color as a,MeshPhysicalMaterial as h,ShaderChunk as c,InstancedMesh as l,Vector3 as d,Object3D as m,TextureLoader as p,FrontSide as g,InstancedBufferAttribute as f,Mesh as u,PlaneGeometry as v,PointLight as y,LatheGeometry as x,PCFSoftShadowMap as w,Raycaster as b}from"https://cdn.jsdelivr.net/npm/three@0.180.0/+esm";import{OrbitControls as z}from"https://cdn.jsdelivr.net/npm/three@0.180.0/examples/jsm/controls/OrbitControls.js/+esm";import"https://cdn.jsdelivr.net/npm/postprocessing@6.37.8/+esm";class R{#e;canvas;camera;cameraMinAspect;cameraMaxAspect;cameraFov;maxPixelRatio;minPixelRatio;scene;renderer;#t;size={width:0,height:0,wWidth:0,wHeight:0,ratio:0,pixelRatio:0};render=this.#i;onBeforeRender=()=>{};onAfterRender=()=>{};onAfterResize=()=>{};#s=!1;#n=!1;isDisposed=!1;#o;#r;#a;#h=new e;#c={elapsed:0,delta:0};#l;constructor(e){this.#e={...e},this.#d(),this.#m(),this.#p(),this.resize(),this.#g()}#d(){this.camera=new t,this.cameraFov=this.camera.fov}#m(){this.scene=new i}#p(){this.#e.canvas?this.canvas=this.#e.canvas:this.#e.id?this.canvas=document.getElementById(this.#e.id):console.error("Three: Missing canvas or id parameter"),this.canvas.style.display="block";const e={canvas:this.canvas,powerPreference:"high-performance",...this.#e.rendererOptions??{}};this.renderer=new s(e),this.renderer.outputColorSpace=n}#g(){this.#e.size instanceof Object||(window.addEventListener("resize",this.#f.bind(this)),"parent"===this.#e.size&&(this.#r=new ResizeObserver(this.#f.bind(this)),this.#r.observe(this.canvas.parentNode))),this.#o=new IntersectionObserver(this.#u.bind(this),{root:null,rootMargin:"0px",threshold:0}),this.#o.observe(this.canvas),document.addEventListener("visibilitychange",this.#v.bind(this))}#y(){window.removeEventListener("resize",this.#f.bind(this)),this.#r?.disconnect(),this.#o?.disconnect(),document.removeEventListener("visibilitychange",this.#v.bind(this))}#u(e){this.#s=e[0].isIntersecting,this.#s?this.#x():this.#w()}#v(e){this.#s&&(document.hidden?this.#w():this.#x())}#f(){this.#a&&clearTimeout(this.#a),this.#a=setTimeout(this.resize.bind(this),100)}resize(){let e,t;this.#e.size instanceof Object?(e=this.#e.size.width,t=this.#e.size.height):"parent"===this.#e.size&&this.canvas.parentNode?(e=this.canvas.parentNode.offsetWidth,t=this.canvas.parentNode.offsetHeight):(e=window.innerWidth,t=window.innerHeight),this.size.width=e,this.size.height=t,this.size.ratio=e/t,this.#b(),this.#z(),this.onAfterResize(this.size)}#b(){this.camera.aspect=this.size.width/this.size.height,this.camera.isPerspectiveCamera&&this.cameraFov&&(this.cameraMinAspect&&this.camera.aspect<this.cameraMinAspect?this.#R(this.cameraMinAspect):this.cameraMaxAspect&&this.camera.aspect>this.cameraMaxAspect?this.#R(this.cameraMaxAspect):this.camera.fov=this.cameraFov),this.camera.updateProjectionMatrix(),this.updateWorldSize()}#R(e){const t=Math.tan(o.degToRad(this.cameraFov/2))/(this.camera.aspect/e);this.camera.fov=2*o.radToDeg(Math.atan(t))}updateWorldSize(){if(this.camera.isPerspectiveCamera){const e=this.camera.fov*Math.PI/180;this.size.wHeight=2*Math.tan(e/2)*this.camera.position.length(),this.size.wWidth=this.size.wHeight*this.camera.aspect}else this.camera.isOrthographicCamera&&(this.size.wHeight=this.camera.top-this.camera.bottom,this.size.wWidth=this.camera.right-this.camera.left)}#z(){this.renderer.setSize(this.size.width,this.size.height),this.#t?.setSize(this.size.width,this.size.height);let e=window.devicePixelRatio;this.maxPixelRatio&&e>this.maxPixelRatio?e=this.maxPixelRatio:this.minPixelRatio&&e<this.minPixelRatio&&(e=this.minPixelRatio),this.renderer.setPixelRatio(e),this.size.pixelRatio=e}get postprocessing(){return this.#t}set postprocessing(e){this.#t=e,this.render=e.render.bind(e)}#x(){if(this.#n)return;console.log("Start rendering");const e=()=>{this.#l=requestAnimationFrame(e),this.#c.delta=this.#h.getDelta(),this.#c.elapsed+=this.#c.delta,this.onBeforeRender(this.#c),this.render(),this.onAfterRender(this.#c)};this.#n=!0,this.#h.start(),e()}#w(){this.#n&&(console.log("Stop rendering"),cancelAnimationFrame(this.#l),this.#n=!1,this.#h.stop())}#i(){this.renderer.render(this.scene,this.camera)}clear(){this.scene.traverse(e=>{e.isMesh&&"object"==typeof e.material&&(Object.keys(e.material).forEach(t=>{const i=e.material[t];null!==i&&"object"==typeof i&&"function"==typeof i.dispose&&i.dispose()}),e.material.dispose(),e.geometry.dispose())}),this.scene.clear()}dispose(){console.log("dispose"),this.#y(),this.#w(),this.clear(),this.#t?.dispose(),this.renderer.dispose(),this.isDisposed=!0}}const C=new Map,P=new r;let M=!1;function S(e){const t={position:new r,nPosition:new r,hover:!1,onEnter(){},onMove(){},onClick(){},onLeave(){},...e};return function(e,t){C.has(e)||(C.set(e,t),M||(document.body.addEventListener("pointermove",A),document.body.addEventListener("pointerleave",L),document.body.addEventListener("click",I),M=!0))}(e.domElement,t),t.dispose=()=>{var t;t=e.domElement,C.delete(t),0===C.size&&(document.body.removeEventListener("pointermove",A),document.body.removeEventListener("pointerleave",L),M=!1)},t}function A(e){P.x=e.clientX,P.y=e.clientY;for(const[e,t]of C){const i=e.getBoundingClientRect();O(i)?(D(t,i),t.hover||(t.hover=!0,t.onEnter(t)),t.onMove(t)):t.hover&&(t.hover=!1,t.onLeave(t))}}function I(e){P.x=e.clientX,P.y=e.clientY;for(const[e,t]of C){const i=e.getBoundingClientRect();D(t,i),O(i)&&t.onClick(t)}}function L(){for(const e of C.values())e.hover&&(e.hover=!1,e.onLeave(e))}function D(e,t){const{position:i,nPosition:s}=e;i.x=P.x-t.left,i.y=P.y-t.top,s.x=i.x/t.width*2-1,s.y=-i.y/t.height*2+1}function O(e){const{x:t,y:i}=P,{left:s,top:n,width:o,height:r}=e;return t>=s&&t<=s+o&&i>=n&&i<=n+r}class E extends h{constructor(e){super(e);this.uniforms={thicknessDistortion:{value:.1},thicknessAmbient:{value:0},thicknessAttenuation:{value:.1},thicknessPower:{value:2},thicknessScale:{value:10}},this.defines.USE_UV="",this.onBeforeCompile=e=>{Object.assign(e.uniforms,this.uniforms),e.fragmentShader="\n        uniform float thicknessPower;\n        uniform float thicknessScale;\n        uniform float thicknessDistortion;\n        uniform float thicknessAmbient;\n        uniform float thicknessAttenuation;\n      "+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("void main() {","\n        void RE_Direct_Scattering(const in IncidentLight directLight, const in vec2 uv, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, inout ReflectedLight reflectedLight) {\n          vec3 scatteringHalf = normalize(directLight.direction + (geometryNormal * thicknessDistortion));\n          float scatteringDot = pow(saturate(dot(geometryViewDir, -scatteringHalf)), thicknessPower) * thicknessScale;\n          #ifdef USE_COLOR\n            vec3 scatteringIllu = (scatteringDot + thicknessAmbient) * vColor;\n          #else\n            vec3 scatteringIllu = (scatteringDot + thicknessAmbient) * diffuse;\n          #endif\n          reflectedLight.directDiffuse += scatteringIllu * thicknessAttenuation * directLight.color;\n        }\n\n        void main() {\n      ");const t=c.lights_fragment_begin.replaceAll("RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );","\n          RE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n          RE_Direct_Scattering(directLight, vUv, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, reflectedLight);\n        ");e.fragmentShader=e.fragmentShader.replace("#include <lights_fragment_begin>",t),this.onBeforeCompile2&&this.onBeforeCompile2(e)}}}const{clamp:k,randFloatSpread:F,randInt:_,smoothstep:N}=o,Z={type:"circle",n:50,padding:0,light1Color:16777215,light1Intensity:500,light1PositionZ:2,light2Color:255,light2Intensity:1e3,light2PositionZ:-5,planeColor:2105376,colors:[16777215,16777215],materialParams:{metalness:1,roughness:1},timeCoef:1,depthScale:.5,influenceRadius1:10,influenceRadius2:20};class U extends l{#C;#c=0;#P;#M;#S;#A;pointerPosition=new d;tilt=new d;#I=new m;#L=new r;#D=new a;constructor(e,t){const i={...Z,...t};let s;"triangle"===i.type?(s=3,i.width=100/(i.n/2+.5),i.height=Math.sin(Math.PI/3)*i.width,i.radius=.5*i.width/Math.cos(Math.PI/6),i.nx=i.n,i.ny=Math.floor(3*i.n/5)):"square"===i.type?(s=4,i.width=100/i.n,i.height=100/i.n,i.radius=.5*i.width,i.nx=i.n,i.ny=Math.floor(2*i.n)):(s="hexagon"===i.type?6:24,i.radius=50/i.n,i.nx=i.n,i.ny=i.n);const n=function(e,t,i,s=0,n=0,o=6){const a=[];a.push(new r(t,-i/2));for(let e=0;e<o;e++){const h=i/2-n+Math.sin((e+1)/o*Math.PI/2)*n,c=t-s+(1-(e+1)/o)*s;a.push(new r(c,h))}a.push(new r(0,i/2));const h=new x(a,e);h.translate(0,-i/2,0),h.rotateX(Math.PI/2);const c=h.attributes.uv.array,l=h.attributes.position.array,m=new d;for(let e=0;e<c.length/2;e+=1){m.fromArray(l,3*e);const i=m.x/t/2+.5,s=m.y/t/2+.5;c[2*e]=i,c[2*e+1]=s}return h}(s,i.radius,10*i.radius,.9*i.radius,.075*i.radius),o=(new p).load("/ps-buttons-black.webp"),h=new E({...i.materialParams,flatShading:"circle"!==i.type,side:g,map:o,roughnessMap:o});super(n,h,i.nx*i.ny);const c=new Uint8Array(this.count).fill(0).map(()=>_(0,3));n.setAttribute("mapIndex",new f(c,1)),h.onBeforeCompile=e=>{e.vertexShader="\n        attribute float mapIndex;\n        varying float vMapIndex;\n        varying float vZ;\n      "+e.vertexShader,e.vertexShader=e.vertexShader.replace("#include <project_vertex>","\n        vec4 mvPosition = vec4( transformed, 1.0 );\n        #ifdef USE_BATCHING\n          mvPosition = batchingMatrix * mvPosition;\n        #endif\n        #ifdef USE_INSTANCING\n          mvPosition = instanceMatrix * mvPosition;\n          vZ = mvPosition.z;\n        #endif\n        mvPosition = modelViewMatrix * mvPosition;\n        gl_Position = projectionMatrix * mvPosition;\n        vMapIndex = mapIndex;\n      "),e.fragmentShader="\n        varying float vMapIndex;\n        varying float vZ;\n      "+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("#include <roughnessmap_fragment>","\n        float roughnessFactor = roughness;\n        #ifdef USE_ROUGHNESSMAP\n          vec2 ruv = vRoughnessMapUv;\n          ruv.x = (vMapIndex + vUv.x) / 4.0;\n          vec4 texelRoughness = texture2D( roughnessMap, ruv );\n          roughnessFactor = smoothstep(0.0, 0.5, vZ) * smoothstep(0.0, 1.0, (texelRoughness.r + texelRoughness.g + texelRoughness.b) / 3.0);\n          // roughnessFactor = (texelRoughness.r + texelRoughness.g + texelRoughness.b) / 3.0;\n        #endif\n      "),e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>","\n        #ifdef USE_MAP\n          vec2 uv = vUv;\n          uv.x = (vMapIndex + vUv.x) / 4.0;\n          vec4 sampledDiffuseColor = texture2D(map, uv);\n          // diffuseColor *= sampledDiffuseColor;\n          diffuseColor *= smoothstep(0.0, 0.5, vZ) * sampledDiffuseColor;\n          // diffuseColor.rgb *= sampledDiffuseColor.rgb * sampledDiffuseColor.a;\n          // diffuseColor.rgb = mix(diffuseColor.rgb, sampledDiffuseColor.rgb, sampledDiffuseColor.a);\n          // diffuseColor.rgb *= sampledDiffuseColor.rgb * sampledDiffuseColor.a;\n        #endif\n      ")},this.#C=e,this.config=i,this.#P=new Array(this.count).fill(0).map(()=>new a),this.#M=new Array(this.count).fill(0).map(()=>new a),this.#S=this.#O(),this.#A=new Float32Array(this.count).fill(0).map(()=>F(2*Math.PI)),this.#E(),this.castShadow=!0,this.receiveShadow=!0,this.setColors(i.colors),this.plane=new u(new v(100,100),new E({color:i.planeColor,...i.materialParams,side:g})),this.plane.receiveShadow=!0,this.plane.position.z=.075*-i.radius,this.add(this.plane)}#E(){const e=new y(this.config.light1Color,this.config.light1Intensity);e.positionZ=this.config.light1PositionZ,e.castShadow=!0,e.shadow.mapSize.width=2048,e.shadow.mapSize.height=2048,e.color2=e.color.clone(),e.intensity2=e.intensity,this.light1=e,this.add(this.light1);const t=new y(this.config.light2Color,this.config.light2Intensity);t.positionZ=this.config.light2PositionZ,t.color2=t.color.clone(),t.intensity2=t.intensity,this.light2=t,this.add(this.light2)}#O(){return"triangle"===this.config.type?function({nx:e,ny:t,width:i,height:s,radius:n}){const o=i/2,r=s,a=-e/2*o+o/2,h=-t/2*r+r/2;return V({nx:e,ny:t},(e,t)=>({x:a+e*o,y:h+t*r+.5*(t%2?-1:1)*(s-n)+e%2*(t%2?1:-1)*(2*n-s),rotZ:(e+t%2)%2*Math.PI/3}))}(this.config):"square"===this.config.type?function({nx:e,ny:t,width:i,height:s}){const n=i,o=s/2,r=-e/2*n+n/4,a=-t/2*o+o/2;return V({nx:e,ny:t},(e,t)=>({x:r+e*n+t%2/2*n,y:a+t*o,rotZ:0}))}(this.config):"hexagon"===this.config.type?function({nx:e,ny:t,radius:i}){const s=Math.cos(Math.PI/6)*i*2,n=1.5*i,o=-e/2*s+s/4,r=-t/2*n+n/2;return V({nx:e,ny:t},(e,t)=>({x:o+e*s+t%2/2*s,y:r+t*n,rotZ:0}))}(this.config):function({nx:e,ny:t,radius:i}){const s=2*i,n=Math.sin(Math.PI/3)*s,o=-e/2*s+s/4,r=-t/2*n+n/2;return V({nx:e,ny:t},(e,t)=>({x:o+e*s+t%2/2*s,y:r+t*n,rotZ:0}))}(this.config)}#k(){const{nx:e,ny:t,depthScale:i,padding:s,influenceRadius1:n,influenceRadius2:o}=this.config;for(let r=0;r<e;r++)for(let e=0;e<t;e++){const a=r*t+e,h=this.#S[a],c=this.#L.set(h.x,h.y).sub(this.pointerPosition).length(),l=(1-N(c,n,o))*N(c,0,n),d=.5*(Math.cos(this.#A[a]+this.#c)+1);this.#I.position.x=h.x,this.#I.position.y=h.y,this.#I.position.z=d*i*l,this.#I.rotation.z=h.rotZ;const m=1-s;this.#I.scale.set(m,m,1),this.#I.updateMatrix(),this.setMatrixAt(a,this.#I.matrix),this.#P[a].lerp(this.#M[a],.05),this.#D.copy(this.plane.material.color).lerp(this.#P[a],N(this.#I.position.z,0,i/2)),this.setColorAt(a,this.#D)}this.instanceMatrix.needsUpdate=!0,this.instanceColor.needsUpdate=!0}setColors(e){if(Array.isArray(e)&&e.length>1){const t=function(e){let t,i;return s(e),{setColors:s,getColorAt:function(e,s=new a){const n=Math.max(0,Math.min(1,e))*(t.length-1),o=Math.floor(n),r=i[o];if(o>=t.length-1)return r.clone();const h=n-o,c=i[o+1];return s.r=r.r+h*(c.r-r.r),s.g=r.g+h*(c.g-r.g),s.b=r.b+h*(c.b-r.b),s}};function s(e){t=e,i=[],t.forEach(e=>{const t=new a(e);i.push(t)})}}(e);for(let e=0;e<this.count;e++)t.getColorAt(Math.random(),this.#M[e])}}resize(){this.#C.size.ratio>1?(this.scale.x=this.#C.size.wWidth/100*1.6,this.scale.y=this.scale.x):(this.scale.y=this.#C.size.wHeight/100*1.6,this.scale.x=this.scale.y)}update(e){this.#c+=e.delta*this.config.timeCoef,this.light1.color.lerp(this.light1.color2,.05),this.light1.intensity+=.05*(this.light1.intensity2-this.light1.intensity),this.light2.color.lerp(this.light2.color2,.05),this.light2.intensity+=.05*(this.light2.intensity2-this.light2.intensity),this.light1.position.set(this.pointerPosition.x,this.pointerPosition.y,this.light1.positionZ),this.light2.position.set(this.pointerPosition.x,this.pointerPosition.y,this.light2.positionZ),this.#k()}}function V({nx:e,ny:t},i){const s=new Array(e*t).fill(0);for(let n=0;n<e;n++)for(let e=0;e<t;e++){s[n*t+e]=i(n,e)}return s}function j(e,t={}){const i=new R({canvas:e,size:"parent",rendererOptions:{antialias:!0}});i.cameraMaxAspect=1,i.minPixelRatio=2,i.camera.position.z=30,i.camera.position.y=-25,i.camera.lookAt(0,0,-10),i.updateWorldSize(),i.renderer.shadowMap.enabled=!0,i.renderer.shadowMap.type=w;const s=new U(i,t);i.scene.add(s);const n=new z(i.camera,i.canvas);n.target.set(0,0,-10),n.enableDamping=!0,n.dampingFactor=.1;const o=new b,r=new d,a=(e=0,t=0)=>{o.setFromCamera({x:e,y:t},i.camera);const n=o.intersectObject(s.plane,!1);n.length>0&&(r.copy(n[0].point),r.x/=s.scale.x,r.y/=s.scale.y)},h=S({domElement:e});return h.onMove=()=>{a(h.nPosition.x,h.nPosition.y)},h.onLeave=()=>{a()},i.onBeforeRender=e=>{n.update(),s.pointerPosition.lerp(r,.05),s.update(e)},i.onAfterResize=()=>{s.resize(),h.hover||(a(),s.pointerPosition.copy(r))},{three:i,grid:s,dispose(){h.dispose(),i.dispose()}}}export{j as default};
